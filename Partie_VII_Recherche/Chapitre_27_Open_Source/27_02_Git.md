# 27.2 Git et Gestion de Versions

---

## Introduction

**Git** est l'outil standard pour la gestion de versions dans les projets open source. Ma√Ætriser Git est essentiel pour contribuer efficacement. Cette section pr√©sente les workflows Git pour contributions open source, incluant fork, branches, pull requests, et r√©solution de conflits.

---

## Workflow Git pour Contributions

### Fork et Clone

```python
"""
Workflow typique:

1. Fork repository GitHub/GitLab
2. Clone votre fork localement
3. Cr√©er branche pour votre contribution
4. Faire changements et commits
5. Push vers votre fork
6. Cr√©er Pull Request vers repository original
"""

class GitContributionWorkflow:
    """
    Workflow Git pour contributions open source
    """
    
    def __init__(self):
        self.workflow_steps = {
            '1_fork': {
                'command': '# Sur GitHub/GitLab, cliquer "Fork"',
                'description': 'Cr√©er copie repository dans votre compte'
            },
            '2_clone': {
                'command': 'git clone https://github.com/YOUR_USERNAME/project.git',
                'description': 'Cloner votre fork localement'
            },
            '3_remote': {
                'command': """
                # Ajouter remote upstream (repository original)
                git remote add upstream https://github.com/ORIGINAL_OWNER/project.git
                git remote -v  # V√©rifier remotes
                """,
                'description': 'Configurer upstream pour sync'
            },
            '4_branch': {
                'command': """
                # Cr√©er branche pour votre feature
                git checkout -b feature/your-feature-name
                # ou
                git checkout -b fix/bug-description
                """,
                'description': 'Cr√©er branche descriptive'
            },
            '5_work': {
                'command': """
                # Faire vos changements
                # Puis:
                git add .
                git commit -m "Clear and descriptive commit message"
                ""',
                'description': 'Committer changements'
            },
            '6_push': {
                'command': 'git push origin feature/your-feature-name',
                'description': 'Push vers votre fork'
            },
            '7_pr': {
                'command': '# Sur GitHub, cr√©er Pull Request',
                'description': 'Proposer vos changements'
            }
        }
    
    def display_workflow(self):
        """Affiche workflow"""
        print("\n" + "="*70)
        print("Workflow Git pour Contributions")
        print("="*70)
        
        for step, info in self.workflow_steps.items():
            print(f"\n{step}:")
            print(f"  {info['description']}")
            print(f"  {info['command']}")

git_workflow = GitContributionWorkflow()
git_workflow.display_workflow()
```

---

## Synchronisation avec Upstream

### Maintenir Fork √† Jour

```python
class UpstreamSync:
    """
    Synchronisation avec repository original
    """
    
    def sync_with_upstream(self):
        """Instructions pour sync"""
        sync_commands = """
# 1. R√©cup√©rer changements upstream
git fetch upstream

# 2. Checkout branche main/master
git checkout main

# 3. Merger changements upstream
git merge upstream/main

# 4. Push vers votre fork
git push origin main

# Alternative: Rebase au lieu de merge
git rebase upstream/main
"""
        return sync_commands
    
    def update_feature_branch(self):
        """Mettre √† jour branche feature avec upstream"""
        commands = """
# Depuis votre branche feature
git checkout feature/your-feature

# R√©cup√©rer et merger upstream
git fetch upstream
git merge upstream/main

# R√©soudre conflits si n√©cessaire
# Puis continuer travail
"""
        return commands
```

---

## Conventions de Commits

### Messages de Commit

```python
class CommitConventions:
    """
    Conventions pour messages de commit
    """
    
    def __init__(self):
        self.conventional_commits = {
            'format': '<type>(<scope>): <subject>',
            'types': {
                'feat': 'Nouvelle fonctionnalit√©',
                'fix': 'Correction bug',
                'docs': 'Changements documentation',
                'style': 'Formatage, point-virgules, etc. (pas de changement code)',
                'refactor': 'Refactoring code (pas de bug fix ni feature)',
                'test': 'Ajout/modification tests',
                'chore': 'T√¢ches maintenance (build, config, etc.)'
            },
            'examples': [
                'feat(compression): add tensor train decomposition',
                'fix(pruning): correct gradient computation',
                'docs(readme): update installation instructions',
                'test(quantization): add unit tests for PTQ',
                'refactor(utils): simplify data loading code'
            ]
        }
    
    def create_good_commit_message(self, change_type: str, 
                                  description: str, 
                                  scope: str = None):
        """Cr√©e bon message de commit"""
        type_desc = self.conventional_commits['types'].get(change_type, change_type)
        
        if scope:
            message = f"{change_type}({scope}): {description}"
        else:
            message = f"{change_type}: {description}"
        
        return {
            'message': message,
            'guidelines': [
                'Premi√®re ligne < 50 caract√®res',
                'Message en imp√©ratif (Add, Fix, not Added, Fixed)',
                'Expliquer quoi et pourquoi, pas comment',
                'Optionnel: corps du message avec d√©tails'
            ]
        }
```

---

## Gestion des Branches

### Strat√©gies de Branches

```python
class BranchManagement:
    """
    Gestion de branches pour contributions
    """
    
    def __init__(self):
        self.branch_strategies = {
            'naming': {
                'feature': 'feature/description',
                'bugfix': 'fix/description',
                'docs': 'docs/description',
                'test': 'test/description',
                'refactor': 'refactor/description'
            },
            'good_practices': [
                'Branches descriptives et courtes',
                'Une branche = une feature/fix',
                'Branches depuis main √† jour',
                'Supprimer branches apr√®s merge'
            ]
        }
    
    def create_feature_branch(self, feature_name: str):
        """Cr√©e branche feature"""
        # Nettoyer nom
        branch_name = feature_name.lower().replace(' ', '-')
        
        commands = f"""
# Depuis main √† jour
git checkout main
git pull upstream main

# Cr√©er et checkout nouvelle branche
git checkout -b feature/{branch_name}
"""
        return commands
    
    def clean_branches(self):
        """Nettoie branches locales"""
        commands = """
# Lister branches merged
git branch --merged

# Supprimer branches merged
git branch -d branch-name

# Forcer suppression si pas merged (attention!)
git branch -D branch-name

# Supprimer branches remote merged
git remote prune origin
"""
        return commands
```

---

## R√©solution de Conflits

### G√©rer Conflits Git

```python
class ConflictResolution:
    """
    R√©solution de conflits Git
    """
    
    def resolve_conflicts(self):
        """Guide r√©solution conflits"""
        steps = """
# 1. Identifier fichiers en conflit
git status

# 2. Ouvrir fichiers conflictuels
# Chercher marqueurs:
# <<<<<<< HEAD
# votre code
# =======
# code de l'autre branche
# >>>>>>> branch-name

# 3. R√©soudre manuellement
# Choisir code √† garder ou combiner

# 4. Marquer comme r√©solu
git add resolved-file.py

# 5. Finaliser merge
git commit

# Ou si rebase:
git rebase --continue

# 6. Annuler si n√©cessaire
git merge --abort
# ou
git rebase --abort
"""
        return steps
    
    def prevent_conflicts(self):
        """Strat√©gies pour √©viter conflits"""
        strategies = [
            'Sync fr√©quemment avec upstream',
            'Branches courtes et focales',
            'Communication avec autres contributeurs',
            'Pull requests petites et fr√©quentes',
            'Rebase avant push (si acceptable dans projet)'
        ]
        return strategies

conflict_resolver = ConflictResolution()
```

---

## Pull Requests

### Cr√©er Pull Request de Qualit√©

```python
class PullRequestGuide:
    """
    Guide pour cr√©er bonnes Pull Requests
    """
    
    def create_pr_template(self):
        """Template PR"""
        template = """
## Description
Brief description des changements

## Type de changement
- [ ] Bug fix
- [ ] Nouvelle fonctionnalit√©
- [ ] Breaking change
- [ ] Documentation

## Checklist
- [ ] Code suit style guide du projet
- [ ] J'ai fait auto-review de mon code
- [ ] J'ai comment√© code complexe
- [ ] J'ai mis √† jour documentation
- [ ] Mes changements ne g√©n√®rent pas warnings
- [ ] J'ai ajout√© tests qui prouvent fix/feature
- [ ] Nouveaux et anciens tests passent localement

## Tests
Description des tests effectu√©s

## Screenshots (si applicable)

## Issues li√©es
Closes #issue_number
"""
        return template
    
    def pr_best_practices(self):
        """Bonnes pratiques PR"""
        practices = {
            'title': [
                'Descriptive et concise',
                'Utiliser format conventionnel si projet l\'utilise',
                'R√©f√©rencer issue si applicable'
            ],
            'description': [
                'Expliquer quoi et pourquoi',
                'D√©crire changements techniques importants',
                'Inclure screenshots si UI change',
                'R√©f√©rencer issues li√©es'
            ],
            'size': [
                'PRs petites et focales',
                'Maximum 400-500 lignes si possible',
                'Si grande PR, diviser en plusieurs'
            ],
            'review': [
                'Auto-review avant soumission',
                'V√©rifier tests passent',
                'V√©rifier linting passe',
                'Pr√™t pour review quand soumis'
            ]
        }
        return practices
```

---

## Exercices

### Exercice 27.2.1
Forkez un projet, cr√©ez branche, faites petit changement, et cr√©ez PR.

### Exercice 27.2.2
Sync votre fork avec upstream et r√©solvez conflits si n√©cessaire.

### Exercice 27.2.3
Cr√©ez commits suivant conventions (Conventional Commits) sur branche de test.

### Exercice 27.2.4
Cr√©ez template de PR personnalis√© pour vos contributions futures.

---

## Points Cl√©s √† Retenir

> üìå **Fork ‚Üí Clone ‚Üí Branch ‚Üí Commit ‚Üí Push ‚Üí PR est workflow standard**

> üìå **Sync fr√©quent avec upstream √©vite conflits**

> üìå **Messages de commit clairs facilitent review et historique**

> üìå **Branches descriptives aident organisation**

> üìå **PRs petites et bien d√©crites ont plus chances acceptation**

> üìå **R√©solution conflits fait partie workflow collaboratif**

---

*Section pr√©c√©dente : [27.1 Principes](./27_01_Principes.md) | Section suivante : [27.3 Documentation et Tests](./27_03_Documentation_Tests.md)*

